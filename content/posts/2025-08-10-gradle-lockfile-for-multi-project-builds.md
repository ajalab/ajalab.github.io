---
title: "Gradle Lockfile for Multi-Project Builds"
date: 2025-08-10T21:00:00+09:00
draft: true
---

_INFO: [Japanese version](https://zenn.dev/ajalab/articles/formally-verifying-kubernetes-controllers) is available in zenn.dev._

----

Gradle allows you to manage dependency library versions by specifying version ranges.
This mechanism is known as [_dynamic versions_](https://docs.gradle.org/current/userguide/dependency_versions.html#sec:dynamic-versions-and-changing-modules). 

To ensure [reproducible builds](https://reproducible-builds.org/), however, it is necessary to lock these version ranges to specific fixed versions.
Lock files such as npm’s [`package-lock.json`](https://docs.npmjs.com/cli/v7/configuring-npm/package-lock-json) and Rust’s [`Cargo.lock`](https://doc.rust-lang.org/cargo/appendix/glossary.html#lock-file) are well known examples of dependency management.
Gradle provides a similar mechanism called [_dependency locking_](https://docs.gradle.org/current/userguide/dependency_locking.html), which generates a lock file named `gradle.lockfile`.

Although dependency locking has been supported since [Gradle 4.8](https://docs.gradle.org/4.8/release-notes.html), it is still not widely used.
This is partly due to the lack of clear guidance on integrating dependency locking with complex project setup, including [multi-project builds](https://docs.gradle.org/current/userguide/multi_project_builds.html), [`buildSrc`](https://docs.gradle.org/current/userguide/sharing_build_logic_between_subprojects.html), and [version catalogs](https://docs.gradle.org/current/userguide/version_catalogs.html) `libs.versions.toml`.

> One does not simply generate a Gradle.lockfile for multi-project builds
>
>-- [Gradle: Generating Multi-Project Lockfiles](https://www.cramhacks.com/p/gradle-multi-project-lockfiles)[^1]

In this article, we will show how to introduce Gradle’s dependency locking into projects structured with multi-project builds and `buildSrc`.

## Preparation

This walkthrough uses [Gradle 8.14.2](https://docs.gradle.org/8.14.2/release-notes.html).

The sample project is available on GitHub at [ajalab/gradle-lockfile-for-multi-projects](https://github.com/ajalab/gradle-lockfile-for-multi-projects), based on its initial commit [`5e67156`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/tree/5e67156e0bb41e55937150abfc4e8077047511c5).
It consists of two Kotlin subprojects, `app1` and `app2`, along with a `buildSrc` build script.
The `buildSrc` directory provides a [convention plugin](https://docs.gradle.org/current/userguide/sharing_build_logic_between_subprojects.html), [`kotlin-jvm.gradle.kts`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/blob/5e67156e0bb41e55937150abfc4e8077047511c5/buildSrc/src/main/kotlin/kotlin-jvm.gradle.kts), which both subprojects use to share common build logic.

All configuration files are written in the Gradle Kotlin DSL (`*.kts`), and most of them were adapted from the ones generated by IntelliJ IDEA’s “Generate multi-module build” option.

Initially, the project specifies Kotlin version 2.1.0. Later, we’ll switch it to a dynamic version to confirm that dependency locking correctly applies the upgrade.

## Adding Dependencies

Commit: [`43ae29f`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/commit/43ae29f756d3164eb7c09d4c4f50a7e25af5c88d)

First, we add the [Spring Boot Gradle Plugin](https://docs.spring.io/spring-boot/gradle-plugin/index.html) (`org.springframework.boot`) and the [Spring Boot Starter](https://docs.spring.io/spring-boot/reference/using/build-systems.html#using.build-systems.starters) (`org.springframework.boot:spring-boot-starter`) as dependencies for both `app1` and `app2`.

```diff
diff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml
index 3ff2f2c..320b016 100644
--- a/gradle/libs.versions.toml
+++ b/gradle/libs.versions.toml
@@ -4,6 +4,11 @@

 [versions]
 kotlin = "2.1.0"
+springBoot = "3.3.13"

 [libraries]
 kotlinGradlePlugin = { module = "org.jetbrains.kotlin:kotlin-gradle-plugin", version.ref = "kotlin" }
+springBootStarter = { module = "org.springframework.boot:spring-boot-starter", version.ref = "springBoot" }
+
+[plugins]
+springBootGradlePlugin = { id = "org.springframework.boot", version.ref = "springBoot" }
```

```diff
diff --git a/app1/build.gradle.kts b/app1/build.gradle.kts
index b0fd2d0..c0ace6f 100644
--- a/app1/build.gradle.kts
+++ b/app1/build.gradle.kts
@@ -1,6 +1,8 @@
 plugins {
     id("buildsrc.convention.kotlin-jvm")
+    alias(libs.plugins.springBootGradlePlugin)
 }

 dependencies {
+    implementation(libs.springBootStarter)
 }
```

```diff
diff --git a/app2/build.gradle.kts b/app2/build.gradle.kts
index b0fd2d0..c0ace6f 100644
--- a/app2/build.gradle.kts
+++ b/app2/build.gradle.kts
@@ -1,6 +1,8 @@
 plugins {
     id("buildsrc.convention.kotlin-jvm")
+    alias(libs.plugins.springBootGradlePlugin)
 }

 dependencies {
+    implementation(libs.springBootStarter)
 }
```

At this point, we specify Spring Boot version `3.3.13`. Later, we’ll switch to a dynamic version to confirm that dependency locking correctly applies the upgrade.

## Enabling Dependency Locking

Commit: [`8ff1725`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/commit/8ff1725be2da4826c4d2e9c1fa3afa65059c8dda)

To enable dependency locking, call [`lockAllConfigurations`](https://docs.gradle.org/current/kotlin-dsl/gradle/org.gradle.api.artifacts.dsl/-dependency-locking-handler/lock-all-configurations.html) [^2] inside the [`dependencyLocking`](https://docs.gradle.org/current/kotlin-dsl/gradle/org.gradle.api/-project/dependency-locking.html) section of your build script.

```kotlin
dependencyLocking {
    lockAllConfigurations()
}
```

Notably, **dependency locking must be configured for each subproject and also for `buildSrc`**. In our example, this requires changes in two places:

- The convention plugin used by the subprojects to share build logic--[`kotlin-jvm.gradle.kts`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/commit/8ff1725be2da4826c4d2e9c1fa3afa65059c8dda#diff-828be282777d91f7228b45a6457fa22c4db6a4e74e47257261cb465bbbf99423)
- The build script for `buildSrc` itself--[`buildSrc/build.gradle.kts`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/commit/8ff1725be2da4826c4d2e9c1fa3afa65059c8dda#diff-7b5c40eb5522b5216cfe8c75612e579a8db0daee9ded80df9ce6a56e8361a962)

## Generating the Lock File

Commit: [`4aff070`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/commit/4aff070083312ee034d9b5d911f91b3c468a0f13)

The lock file `gradle.lockfile` records the fixed versions of dependencies, including all transitive dependencies.

[`app1/gradle.lockfile`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/blob/4aff070083312ee034d9b5d911f91b3c468a0f13/app1/gradle.lockfile)
```properties
# This is a Gradle generated file for dependency locking.
# Manual edits can break the build and are not advised.
# This file is expected to be part of source control.
ch.qos.logback:logback-classic:1.5.18=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
ch.qos.logback:logback-core:1.5.18=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
io.github.java-diff-utils:java-diff-utils:4.12=kotlinInternalAbiValidation
...
```

To generate the lock file, run a Gradle task with the `--write-locks` option.

In a multi-project Gradle setup, **lock files are generated for each subproject as well as for `buildSrc`**.
A common pitfall is that while the [official documentation](https://docs.gradle.org/current/userguide/dependency_locking.html) shows running `gradle dependencies --write-locks` at the root project, **this does not generate lock files for the subprojects**[^3].

> In a multi-project setup, note that `dependencies` is executed only on one project, typically the root project.
>
> -- [Locking Versions](https://docs.gradle.org/current/userguide/dependency_locking.html)

One workaround is to run the `dependencies` task individually for each subproject.

```sh
gradle :buildSrc:dependencies --write-locks
gradle :app1:dependencies --write-locks
gradle :app2:dependencies --write-locks
```

However, specifying each subproject individually can be cumbersome.
We will look at two methods to simplify it.

### Using the `build` Task

Running the `dependencies` task without specifying project paths targets only the root project, so lock files won’t be generated for subprojects.
Instead, by using a task like `build` that runs across all subprojects, you can generate lock files for all subprojects in a single command execution.

```sh
gradle build --write-locks
```

### Defining a Task to Run the `dependencies` Task for All Subprojects

Using the `build` task has the downside of triggering an actual build, which is unnecessary just for generating lock files.

As an alternative, you can define a custom task that depends on the `dependencies` task of all subprojects.
Below is an example of defining such a task named `allDependencies`[^4].

[`build.gradle.kts`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/blob/3b290af0624ff1514a3d9cf1ebfcdfc12fff01aa/build.gradle.kts)
```kotlin
tasks.register("allDependencies") {
    dependsOn(
        subprojects.flatMap { subproject ->
            subproject.tasks.matching { it.name == "dependencies" }
        }
    )
}
```

By running this `allDependencies` task with the `--write-locks` option, you can generate lock files for all subprojects in a single step.

```sh
gradle allDependencies --write-locks
```

## Specifying Version Ranges

Commit: [`d8df924`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/commit/d8df924771b762fb37e1bdd4f5d68282e2cb3ceb)

With the lock files generated, we can now specify version ranges for Kotlin and Spring Boot using [dynamic versions](https://docs.gradle.org/current/userguide/dependency_versions.html#sec:dynamic-versions-and-changing-modules).
Version ranges can be set directly in the `versions` section of the version catalog.

[`gradle/libs.versions.toml`](https://github.com/ajalab/gradle-lockfile-for-multi-projects/blob/d8df924771b762fb37e1bdd4f5d68282e2cb3ceb/gradle/libs.versions.toml)
```toml
[versions]
kotlin = "2.+"
springBoot = "3.+"
```

The `+` symbol acts as a prefix descriptor for version matching.

At this point, since the lock files haven’t been updated yet, running the build will still use the old versions (`kotlin = "2.1.0"` and `springBoot = "3.3.13"`).

## Updating the Lock File

To update the lock file, rerun the `dependencies` task (or similar) with the `--write-locks` option, just like when you initially generated it.

After running this, the lock file will reflect the updated versions (`kotlin = "2.2.20"` and `springBoot = "3.5.4"`).

```diff
diff --git i/buildSrc/gradle.lockfile w/buildSrc/gradle.lockfile
index fc38189..1f0a988 100644
--- i/buildSrc/gradle.lockfile
+++ w/buildSrc/gradle.lockfile
@@ -1,29 +1,32 @@
 # This is a Gradle generated file for dependency locking.
 # Manual edits can break the build and are not advised.
 # This file is expected to be part of source control.

...

+org.jetbrains.kotlin:kotlin-compiler-runner:2.2.20-Beta2=buildScriptClasspath,runtimeClasspath
 org.jetbrains.kotlin:kotlin-daemon-client:2.0.21=kotlinBuildToolsApiClasspath
-org.jetbrains.kotlin:kotlin-daemon-client:2.1.0=buildScriptClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-daemon-client:2.2.20-Beta2=buildScriptClasspath,runtimeClasspath
 org.jetbrains.kotlin:kotlin-daemon-embeddable:2.0.21=kotlinBuildToolsApiClasspath,kotlinCompilerClasspath
-org.jetbrains.kotlin:kotlin-gradle-plugin-annotations:2.1.0=buildScriptClasspath,compileClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-gradle-plugin-api:2.1.0=buildScriptClasspath,compileClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-gradle-plugin-idea-proto:2.1.0=buildScriptClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-gradle-plugin-idea:2.1.0=buildScriptClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-gradle-plugin-model:2.1.0=buildScriptClasspath,compileClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-gradle-plugin:2.1.0=buildScriptClasspath,compileClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-gradle-plugins-bom:2.1.0=buildScriptClasspath,compileClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-klib-commonizer-api:2.1.0=buildScriptClasspath,runtimeClasspath
-org.jetbrains.kotlin:kotlin-native-utils:2.1.0=buildScriptClasspath,compileClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-gradle-plugin-annotations:2.2.20-Beta2=buildScriptClasspath,compileClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-gradle-plugin-api:2.2.20-Beta2=buildScriptClasspath,compileClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-gradle-plugin-idea-proto:2.2.20-Beta2=buildScriptClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-gradle-plugin-idea:2.2.20-Beta2=buildScriptClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-gradle-plugin-model:2.2.20-Beta2=buildScriptClasspath,compileClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-gradle-plugin:2.2.20-Beta2=buildScriptClasspath,compileClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-gradle-plugins-bom:2.2.20-Beta2=buildScriptClasspath,compileClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-klib-commonizer-api:2.2.20-Beta2=buildScriptClasspath,runtimeClasspath
+org.jetbrains.kotlin:kotlin-native-utils:2.2.20-Beta2=buildScriptClasspath,compileClasspath,runtimeClasspath

...
```

```diff
diff --git i/app1/gradle.lockfile w/app1/gradle.lockfile
index 1e2875b..81d8baa 100644
--- i/app1/gradle.lockfile
+++ w/app1/gradle.lockfile
@@ -3,49 +3,55 @@
 # This file is expected to be part of source control.

...

 org.slf4j:slf4j-api:2.0.17=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework.boot:spring-boot-autoconfigure:3.3.13=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework.boot:spring-boot-starter-logging:3.3.13=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework.boot:spring-boot-starter:3.3.13=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework.boot:spring-boot:3.3.13=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework:spring-aop:6.1.21=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework:spring-beans:6.1.21=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework:spring-context:6.1.21=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework:spring-core:6.1.21=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework:spring-expression:6.1.21=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.springframework:spring-jcl:6.1.21=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
-org.yaml:snakeyaml:2.2=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework.boot:spring-boot-autoconfigure:3.5.4=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework.boot:spring-boot-starter-logging:3.5.4=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework.boot:spring-boot-starter:3.5.4=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework.boot:spring-boot:3.5.4=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework:spring-aop:6.2.9=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework:spring-beans:6.2.9=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework:spring-context:6.2.9=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework:spring-core:6.2.9=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework:spring-expression:6.2.9=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.springframework:spring-jcl:6.2.9=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,testImplementationDependenciesMetadata,testRuntimeClasspath
+org.yaml:snakeyaml:2.4=compileClasspath,implementationDependenciesMetadata,productionRuntimeClasspath,runtimeClasspath,testCompileClasspath,test
ImplementationDependenciesMetadata,testRuntimeClasspath
```

## Summary

In this article, we demonstrated how to introduce dependency locking into a Gradle project structured with a multi-project build.

[^1]: An example of introducing Gradle dependency locking can be found in the Elasticsearch project ([elastic/elasticsearch](https://github.com/elastic/elasticsearch)).

[^2]: To enable dependency locking for specific [dependency configurations](https://docs.gradle.org/current/userguide/dependency_configurations.html), such as `compileClasspath`, call `activateDependencyLocking` on the target configuration within the `configurations` block. See [Activate locking for specific configurations](https://docs.gradle.org/current/userguide/dependency_locking.html#sec:dependency-locking) for details.

[^3]: The issue where the `dependencies` task does not generate lock files for subprojects is discussed in [gradle/gradle#9373](https://github.com/gradle/gradle/issues/9373). Unfortunately, the fix is currently [not planned](https://github.com/gradle/gradle/issues/9373#event-7404527159).

[^4]: The idea originates from a [comment](https://github.com/gradle/gradle/issues/9373#issuecomment-2284304502) in [gradle/gradle#9373](https://github.com/gradle/gradle/issues/9373).
